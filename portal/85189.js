(self.webpackChunkportal=self.webpackChunkportal||[]).push([[85189],{85189:(F,m,a)=>{a.r(m),a.d(m,{AUTH_FLOW_STRATEGY:()=>C,AbpOAuthGuard:()=>D,AbpOAuthModule:()=>B,AbpOAuthService:()=>P,AuthCodeFlowStrategy:()=>k,AuthFlowStrategy:()=>E,AuthPasswordFlowStrategy:()=>R,NavigateToManageProfileProvider:()=>L,OAuthApiInterceptor:()=>w,OAuthConfigurationHandler:()=>b,checkAccessToken:()=>U,clearOAuthStorage:()=>v,oAuthStorage:()=>p,pipeToLogin:()=>y,removeRememberMe:()=>S,setRememberMe:()=>O,storageFactory:()=>W});var d=a(49671),c=a(11705),T=a(62411),u=a(15137),s=a(81011),i=a(4125),o=a(32070),l=a(28675),f=a(81686),A=a(39611);const p=localStorage;function v(r=p){["access_token","id_token","refresh_token","nonce","PKCE_verifier","expires_at","id_token_claims_obj","id_token_expires_at","id_token_stored_at","access_token_stored_at","granted_scopes","session_state"].forEach(e=>r.removeItem(e))}class E{constructor(t){this.injector=t,this.catchError=e=>(this.httpErrorReporter.reportError(e),(0,i.of)(null)),this.httpErrorReporter=t.get(s.HttpErrorReporterService),this.environment=t.get(s.EnvironmentService),this.configState=t.get(s.ConfigStateService),this.oAuthService=t.get(u.Ct),this.sessionState=t.get(s.SessionStateService),this.localStorageService=t.get(s.AbpLocalStorageService),this.oAuthConfig=this.environment.getEnvironment().oAuthConfig||{},this.tenantKey=t.get(s.TENANT_KEY),this.router=t.get(l.Router),this.listenToOauthErrors()}init(){var t=this;return(0,d.Z)(function*(){return t.oAuthConfig.clientId&&function K(r,t){const e="abpOAuthClientId";if(!t.getItem(e))return t.setItem(e,r),!1;const n=t.getItem(e)!==r;return n&&t.setItem(e,r),n}(t.oAuthConfig.clientId,p)&&v(p),t.oAuthService.configure(t.oAuthConfig),t.oAuthService.events.pipe((0,o.filter)(e=>"token_refresh_error"===e.type)).subscribe(()=>t.navigateToLogin()),t.navigateToPreviousUrl(),t.oAuthService.loadDiscoveryDocument().then(()=>t.oAuthService.hasValidAccessToken()||!t.oAuthService.getRefreshToken()?Promise.resolve():t.refreshToken()).catch(t.catchError)})()}navigateToPreviousUrl(){const{responseType:t}=this.oAuthConfig;"code"===t&&this.oAuthService.events.pipe((0,o.filter)(e=>"token_received"===e.type&&!!this.oAuthService.state),(0,o.take)(1),(0,o.map)(()=>{const e=decodeURIComponent(this.oAuthService.state);return e&&"/"!==e?e:"/"}),(0,o.switchMap)(e=>this.configState.getOne$("currentUser").pipe((0,o.filter)(n=>!!n?.isAuthenticated),(0,o.tap)(()=>this.router.navigate([e]))))).subscribe()}refreshToken(){return this.oAuthService.refreshToken().catch(()=>v())}listenToOauthErrors(){this.oAuthService.events.pipe((0,o.filter)(t=>t instanceof u.Ki),(0,o.tap)(()=>v()),(0,o.switchMap)(()=>this.configState.refreshAppState())).subscribe()}}class k extends E{constructor(){super(...arguments),this.isInternalAuth=!1}init(){var t=()=>super.init,e=this;return(0,d.Z)(function*(){return t().call(e).then(()=>e.oAuthService.tryLogin().catch(s.noop)).then(()=>e.oAuthService.setupAutomaticSilentRefresh({},"access_token"))})()}navigateToLogin(t){let e="";t?.returnUrl&&(e=t.returnUrl);const n=this.getCultureParams(t);this.oAuthService.initCodeFlow(e,n)}checkIfInternalAuth(t){return this.oAuthService.initCodeFlow("",this.getCultureParams(t)),!1}logout(t){return(0,i.from)(this.oAuthService.revokeTokenAndLogout(this.getCultureParams(t)))}login(t){return this.oAuthService.initCodeFlow("",this.getCultureParams(t)),(0,i.of)(null)}getCultureParams(t){const e=this.sessionState.getLanguage();return{...e&&{culture:e,"ui-culture":e},...t}}}const I="rememberMe",M="passwordFlow",y=function(r,t){const e=t.get(s.ConfigStateService),n=t.get(l.Router),h=t.get(s.AbpLocalStorageService);return(0,i.pipe)((0,o.switchMap)(()=>e.refreshAppState()),(0,o.tap)(()=>{O(r.rememberMe,h),r.redirectUrl&&n.navigate([r.redirectUrl])}))};function O(r,t){S(t),t.setItem(M,"true"),document.cookie=`${I}=true; path=/${r?" ;expires=Fri, 31 Dec 9999 23:59:59 GMT":""}`}function S(r){r.removeItem(M),document.cookie=I+"= ; path=/; expires = Thu, 01 Jan 1970 00:00:00 GMT"}class R extends E{constructor(){super(...arguments),this.isInternalAuth=!0,this.cookieKey="rememberMe",this.storageKey="passwordFlow"}listenToTokenExpiration(){this.oAuthService.events.pipe((0,o.filter)(t=>t instanceof u.Dt&&"token_expires"===t.type&&"access_token"===t.info)).subscribe(()=>{this.oAuthService.getRefreshToken()?this.refreshToken():(this.oAuthService.logOut(),S(this.localStorageService),this.configState.refreshAppState().subscribe())})}init(){var t=()=>super.init,e=this;return(0,d.Z)(function*(){return!function N(r){const t=document.cookie.match(new RegExp("(^| )"+r+"=([^;]+)"));return t?t[2]:""}(e.cookieKey)&&localStorage.getItem(e.storageKey)&&e.oAuthService.logOut(),t().call(e).then(()=>e.listenToTokenExpiration())})()}navigateToLogin(t){return this.injector.get(l.Router).navigate(["/account/login"],{queryParams:t})}checkIfInternalAuth(){return!0}login(t){const e=this.sessionState.getTenant();return(0,i.from)(this.oAuthService.fetchTokenUsingPasswordFlow(t.username,t.password,new f.HttpHeaders({...e&&e.id&&{[this.tenantKey]:e.id}}))).pipe(y(t,this.injector))}logout(){const t=this.injector.get(l.Router);return(0,i.from)(this.oAuthService.revokeTokenAndLogout(!0)).pipe((0,o.switchMap)(()=>this.configState.refreshAppState()),(0,o.tap)(()=>{t.navigateByUrl("/"),S(this.localStorageService)}))}refreshToken(){return this.oAuthService.refreshToken().catch(()=>{v(),S(this.localStorageService)})}}const C={Code:r=>new k(r),Password:r=>new R(r)};let P=(()=>{class r{get isInternalAuth(){return this.strategy.isInternalAuth}constructor(e){this.injector=e,this.oAuthService=this.injector.get(u.Ct)}init(){var e=this;return(0,d.Z)(function*(){const h=e.injector.get(s.EnvironmentService).getEnvironment$().pipe((0,o.map)(g=>g?.oAuthConfig),(0,o.filter)(Boolean),(0,o.tap)(g=>{e.strategy="code"===g.responseType?C.Code(e.injector):C.Password(e.injector)}),(0,o.switchMap)(()=>(0,i.from)(e.strategy.init())),(0,o.take)(1));return yield(0,i.lastValueFrom)(h)})()}logout(e){return this.strategy.logout(e)}navigateToLogin(e){this.strategy.navigateToLogin(e)}login(e){return this.strategy.login(e)}get isAuthenticated(){return this.oAuthService.hasValidAccessToken()}loginUsingGrant(e,n,h){const{clientId:g,dummyClientSecret:_}=this.oAuthService,j={access_token:this.oAuthService.getAccessToken(),grant_type:e,client_id:g,...n};return _&&(j.client_secret=_),this.oAuthService.fetchTokenUsingGrant(e,j,h)}static#e=this.\u0275fac=function(n){return new(n||r)(c.\u0275\u0275inject(c.Injector))};static#t=this.\u0275prov=c.\u0275\u0275defineInjectable({token:r,factory:r.\u0275fac,providedIn:"root"})}return r})(),b=(()=>{class r{constructor(e,n,h){this.oAuthService=e,this.environmentService=n,this.options=h,this.listenToSetEnvironment()}listenToSetEnvironment(){this.environmentService.createOnUpdateStream(e=>e).pipe((0,o.map)(e=>e.oAuthConfig),(0,o.filter)(e=>!(0,A.Z)(e,this.options.environment.oAuthConfig))).subscribe(e=>{this.oAuthService.configure(e)})}static#e=this.\u0275fac=function(n){return new(n||r)(c.\u0275\u0275inject(u.Ct),c.\u0275\u0275inject(s.EnvironmentService),c.\u0275\u0275inject(s.CORE_OPTIONS))};static#t=this.\u0275prov=c.\u0275\u0275defineInjectable({token:r,factory:r.\u0275fac,providedIn:"root"})}return r})(),w=(()=>{class r{constructor(e,n,h,g){this.oAuthService=e,this.sessionState=n,this.httpWaitService=h,this.tenantKey=g}intercept(e,n){this.httpWaitService.addRequest(e);const g=e.context?.get(s.IS_EXTERNAL_REQUEST)?e:e.clone({setHeaders:this.getAdditionalHeaders(e.headers)});return n.handle(g).pipe((0,o.finalize)(()=>this.httpWaitService.deleteRequest(e)))}getAdditionalHeaders(e){const n={},h=this.oAuthService.getAccessToken();!e?.has("Authorization")&&h&&(n.Authorization=`Bearer ${h}`);const g=this.sessionState.getLanguage();!e?.has("Accept-Language")&&g&&(n["Accept-Language"]=g);const _=this.sessionState.getTenant();return!e?.has(this.tenantKey)&&_?.id&&(n[this.tenantKey]=_.id),n["X-Requested-With"]="XMLHttpRequest",n}static#e=this.\u0275fac=function(n){return new(n||r)(c.\u0275\u0275inject(u.Ct),c.\u0275\u0275inject(s.SessionStateService),c.\u0275\u0275inject(s.HttpWaitService),c.\u0275\u0275inject(s.TENANT_KEY))};static#t=this.\u0275prov=c.\u0275\u0275defineInjectable({token:r,factory:r.\u0275fac,providedIn:"root"})}return r})(),D=(()=>{class r{constructor(){this.oAuthService=(0,c.inject)(u.Ct),this.authService=(0,c.inject)(s.AuthService),this.httpErrorReporter=(0,c.inject)(s.HttpErrorReporterService)}canActivate(e,n){return!!this.oAuthService.hasValidAccessToken()||(0,i.of)(!1).pipe((0,i.tap)(()=>this.httpErrorReporter.reportError({status:401})),(0,i.delay)(1500),(0,i.tap)(()=>{this.authService.navigateToLogin({returnUrl:n.url})}))}static#e=this.\u0275fac=function(n){return new(n||r)};static#t=this.\u0275prov=c.\u0275\u0275defineInjectable({token:r,factory:r.\u0275fac,providedIn:"root"})}return r})();const L={provide:s.NAVIGATE_TO_MANAGE_PROFILE,useFactory:()=>{const r=(0,c.inject)(s.EnvironmentService);return()=>{const t=r.getEnvironment();if(!t.oAuthConfig)return void console.warn("The oAuthConfig env is missing on environment.ts");const{issuer:e}=t.oAuthConfig,n=e.endsWith("/")?e:`${e}/`;window.open(`${n}Account/Manage?returnUrl=${window.location.href}`,"_self")}}};function W(){return p}const U=function(r){const t=r.get(s.ConfigStateService);r.get(u.Ct).hasValidAccessToken()&&!t.getDeep("currentUser.id")&&v()};let B=(()=>{class r{static forRoot(){return{ngModule:r,providers:[{provide:s.AuthService,useClass:P},{provide:s.AuthGuard,useClass:D},{provide:s.ApiInterceptor,useClass:w},{provide:s.PIPE_TO_LOGIN_FN_KEY,useValue:y},{provide:s.CHECK_AUTHENTICATION_STATE_FN_KEY,useValue:U},{provide:f.HTTP_INTERCEPTORS,useExisting:s.ApiInterceptor,multi:!0},L,{provide:c.APP_INITIALIZER,multi:!0,deps:[b],useFactory:s.noop},u.zr.forRoot().providers,{provide:u.Hy,useClass:s.AbpLocalStorageService}]}}static#e=this.\u0275fac=function(n){return new(n||r)};static#t=this.\u0275mod=c.\u0275\u0275defineNgModule({type:r});static#r=this.\u0275inj=c.\u0275\u0275defineInjector({imports:[T.CommonModule,u.zr]})}return r})()},39611:(F,m,a)=>{a.d(m,{Z:()=>d});var d=c;function c(i,o){return i===o||i!=i&&o!=o||!(typeof i!=typeof o||{}.toString.call(i)!={}.toString.call(o)||i!==Object(i)||!i)&&(Array.isArray(i)?u(i,o):"[object Set]"=={}.toString.call(i)?u(Array.from(i),Array.from(o)):"[object Object]"=={}.toString.call(i)?function s(i,o){var l=Object.keys(i),f=l.length;if(f!=Object.keys(o).length)return!1;for(var A=0;A<f;A++){var p=l[A];if(!o.hasOwnProperty(p)||!c(i[p],o[p]))return!1}return!0}(i,o):function T(i,o){return i.toString()===o.toString()}(i,o))}function u(i,o){var l=i.length;if(l!=o.length)return!1;for(var f=0;f<l;f++)if(!c(i[f],o[f]))return!1;return!0}}}]);